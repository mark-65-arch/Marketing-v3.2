---
// üç™ Cookie Consent Banner Component
// Purpose: GDPR/CCPA compliant cookie consent with granular controls
// Features: localStorage persistence, accessible, mobile-friendly

const BASE_URL = import.meta.env.BASE_URL;
---

<!-- üç™ Cookie Consent Banner -->
<div
  id="cookie-banner"
  class="fixed bottom-0 left-0 right-0 z-50 transform translate-y-full transition-transform duration-300 ease-in-out"
  role="dialog"
  aria-labelledby="cookie-banner-title"
  aria-describedby="cookie-banner-description"
  aria-hidden="true"
>
  <div class="bg-slate-900/95 backdrop-blur-sm border-t border-slate-700 shadow-2xl">
    <div class="container mx-auto px-4 py-4 sm:py-6 max-w-7xl">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">

        <!-- üìù Banner Content -->
        <div class="flex-1">
          <h2 id="cookie-banner-title" class="text-white font-semibold text-lg mb-2 flex items-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
              <path d="M10 2a8 8 0 100 16 8 8 0 000-16zM7 9a1 1 0 100-2 1 1 0 000 2zm3-4a1 1 0 11-2 0 1 1 0 012 0zm1 7a1 1 0 100-2 1 1 0 000 2zm3-3a1 1 0 11-2 0 1 1 0 012 0z"/>
            </svg>
            Cookie Preferences
          </h2>
          <p id="cookie-banner-description" class="text-gray-300 text-sm sm:text-base mb-2">
            We use cookies to improve your experience, analyze site traffic, and show relevant ads.
          </p>
          <p class="text-gray-400 text-xs">
            Manage your choices anytime in Cookie settings. By clicking Accept all cookies you agree to our
            <a href={`${BASE_URL}legal/cookie-policy`} class="text-blue-400 hover:text-blue-300 underline">Cookie Policy</a> and
            <a href={`${BASE_URL}legal/privacy-policy`} class="text-blue-400 hover:text-blue-300 underline">Privacy Policy</a>.
          </p>
        </div>

        <!-- üéõÔ∏è Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 lg:flex-shrink-0">
          <button
            id="cookie-settings-btn"
            class="px-4 py-2.5 text-sm font-medium text-white bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors duration-200 focus:ring-4 focus:ring-slate-500 focus:outline-none whitespace-nowrap"
            aria-label="Open cookie settings"
          >
            Cookie settings
          </button>
          <button
            id="cookie-reject-btn"
            class="px-4 py-2.5 text-sm font-medium text-slate-900 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors duration-200 focus:ring-4 focus:ring-gray-300 focus:outline-none whitespace-nowrap"
            aria-label="Reject non-essential cookies"
          >
            Reject non-essential
          </button>
          <button
            id="cookie-accept-btn"
            class="px-4 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-teal-600 hover:from-blue-700 hover:to-teal-700 rounded-lg transition-all duration-200 focus:ring-4 focus:ring-blue-300 focus:outline-none whitespace-nowrap"
            aria-label="Accept all cookies"
          >
            Accept all cookies
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- üéõÔ∏è Cookie Settings Modal -->
<div
  id="cookie-settings-modal"
  class="fixed inset-0 z-50 hidden"
  role="dialog"
  aria-labelledby="cookie-modal-title"
  aria-modal="true"
>
  <!-- Backdrop -->
  <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" id="cookie-modal-backdrop"></div>

  <!-- Modal Content -->
  <div class="fixed inset-0 overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full transform transition-all">

        <!-- Modal Header -->
        <div class="border-b border-gray-200 px-6 py-4 flex items-center justify-between">
          <h2 id="cookie-modal-title" class="text-2xl font-bold text-slate-900">
            Cookie Settings
          </h2>
          <button
            id="cookie-modal-close"
            class="text-gray-400 hover:text-gray-600 transition-colors p-2 rounded-full hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 focus:outline-none"
            aria-label="Close cookie settings"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <!-- Modal Body -->
        <div class="px-6 py-6 max-h-96 overflow-y-auto">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <p class="text-sm text-blue-900">
              <strong>About Analytics:</strong> We use analytics to understand how visitors use our site. These cookies are enabled by default to help us improve performance. You can opt out anytime.
            </p>
          </div>

          <p class="text-gray-600 mb-6">
            Choose which cookies you want to allow. You can change these settings at any time.
          </p>

          <!-- Cookie Categories -->
          <div class="space-y-4">

            <!-- Strictly Necessary -->
            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h3 class="font-semibold text-slate-900 mb-1">Strictly Necessary Cookies</h3>
                  <p class="text-sm text-gray-600">
                    Required for the website to function. These cannot be disabled.
                  </p>
                </div>
                <div class="ml-4">
                  <input
                    type="checkbox"
                    id="cookie-necessary"
                    checked
                    disabled
                    class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-not-allowed opacity-50"
                    aria-label="Strictly necessary cookies (always enabled)"
                  />
                </div>
              </div>
            </div>

            <!-- Analytics -->
            <div class="border border-blue-200 rounded-lg p-4 bg-blue-50 hover:border-blue-300 transition-colors">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h3 class="font-semibold text-slate-900 mb-1 flex items-center gap-2">
                    Analytics Cookies
                    <span class="text-xs font-normal bg-blue-600 text-white px-2 py-0.5 rounded">Enabled by Default</span>
                  </h3>
                  <p class="text-sm text-gray-700 mb-2">
                    Help us understand how visitors interact with our website (Google Analytics).
                  </p>
                  <p class="text-xs text-gray-600 italic">
                    These cookies are enabled by default. Uncheck to opt out.
                  </p>
                </div>
                <div class="ml-4">
                  <input
                    type="checkbox"
                    id="cookie-analytics"
                    checked
                    class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                    aria-label="Enable analytics cookies"
                  />
                </div>
              </div>
            </div>

            <!-- Marketing -->
            <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h3 class="font-semibold text-slate-900 mb-1">Marketing Cookies</h3>
                  <p class="text-sm text-gray-600">
                    Used to show you relevant ads and measure campaign effectiveness.
                  </p>
                </div>
                <div class="ml-4">
                  <input
                    type="checkbox"
                    id="cookie-marketing"
                    class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                    aria-label="Enable marketing cookies"
                  />
                </div>
              </div>
            </div>

            <!-- Functional -->
            <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h3 class="font-semibold text-slate-900 mb-1">Functional Cookies</h3>
                  <p class="text-sm text-gray-600">
                    Remember your preferences and provide enhanced features.
                  </p>
                </div>
                <div class="ml-4">
                  <input
                    type="checkbox"
                    id="cookie-functional"
                    class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                    aria-label="Enable functional cookies"
                  />
                </div>
              </div>
            </div>

          </div>

          <!-- Learn More Link -->
          <div class="mt-6 pt-6 border-t border-gray-200">
            <p class="text-sm text-gray-600">
              For more information, see our
              <a href={`${BASE_URL}legal/cookie-policy`} class="text-blue-600 hover:text-blue-700 underline font-medium">Cookie Policy</a>.
            </p>
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="border-t border-gray-200 px-6 py-4 flex flex-col sm:flex-row gap-3 sm:justify-end">
          <button
            id="cookie-modal-reject"
            class="px-6 py-2.5 text-sm font-medium text-slate-900 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors duration-200 focus:ring-4 focus:ring-gray-300 focus:outline-none"
          >
            Reject All
          </button>
          <button
            id="cookie-modal-save"
            class="px-6 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-teal-600 hover:from-blue-700 hover:to-teal-700 rounded-lg transition-all duration-200 focus:ring-4 focus:ring-blue-300 focus:outline-none"
          >
            Save Preferences
          </button>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  // üç™ Cookie Consent Management with GTM/GA4 Integration
  import {
    getConsentPreferences,
    saveConsentPreferences,
    acceptAllCookies,
    rejectNonEssentialCookies,
    hasGivenConsent,
    isAnalyticsEnabled,
    getDefaultPreferences
  } from '../utils/consent';
  import {
    initializeGTM,
    initializeGA4,
    enableAnalytics,
    disableAnalytics
  } from '../utils/analytics';

  class CookieConsentUI {
    private banner: HTMLElement | null;
    private modal: HTMLElement | null;
    private previousFocus: HTMLElement | null = null;

    // Get GTM/GA4 IDs from environment or meta tags
    private gtmId: string = import.meta.env.PUBLIC_GTM_ID || 'GTM-KQS29VV6';
    private ga4Id: string = import.meta.env.PUBLIC_GA4_ID || '';

    constructor() {
      this.banner = document.getElementById('cookie-banner');
      this.modal = document.getElementById('cookie-settings-modal');
      this.init();
    }

    init() {
      // Check if user has given consent
      const hasConsent = hasGivenConsent();

      if (!hasConsent) {
        // No consent given yet - show banner
        this.showBanner();

        // Initialize analytics with default (enabled) since analytics is enabled by default
        if (isAnalyticsEnabled()) {
          this.initializeAnalytics();
        }
      } else {
        // User has given consent - apply their preferences
        if (isAnalyticsEnabled()) {
          this.initializeAnalytics();
        }
      }

      this.bindEvents();
    }

    bindEvents() {
      // Banner buttons
      document.getElementById('cookie-accept-btn')?.addEventListener('click', () => {
        this.handleAcceptAll();
      });

      document.getElementById('cookie-reject-btn')?.addEventListener('click', () => {
        this.handleRejectNonEssential();
      });

      document.getElementById('cookie-settings-btn')?.addEventListener('click', () => {
        this.openModal();
      });

      // Modal buttons
      document.getElementById('cookie-modal-close')?.addEventListener('click', () => {
        this.closeModal();
      });

      document.getElementById('cookie-modal-backdrop')?.addEventListener('click', () => {
        this.closeModal();
      });

      document.getElementById('cookie-modal-save')?.addEventListener('click', () => {
        this.handleSavePreferences();
      });

      document.getElementById('cookie-modal-reject')?.addEventListener('click', () => {
        this.handleRejectNonEssential();
        this.closeModal();
      });

      // Keyboard accessibility
      this.modal?.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          this.closeModal();
        }
      });

      // Listen for consent changes
      window.addEventListener('consentChanged', ((e: CustomEvent) => {
        const preferences = e.detail;

        if (preferences.analytics) {
          this.initializeAnalytics();
        } else {
          disableAnalytics(this.ga4Id);
        }
      }) as EventListener);
    }

    initializeAnalytics() {
      if (this.gtmId) {
        initializeGTM(this.gtmId);
      }
      if (this.ga4Id) {
        initializeGA4(this.ga4Id);
      }
    }

    handleAcceptAll() {
      acceptAllCookies();
      this.hideBanner();
      // Analytics will be initialized via consentChanged event
    }

    handleRejectNonEssential() {
      rejectNonEssentialCookies();
      this.hideBanner();
      // Analytics will be disabled via consentChanged event
    }

    handleSavePreferences() {
      const analytics = (document.getElementById('cookie-analytics') as HTMLInputElement)?.checked || false;
      const marketing = (document.getElementById('cookie-marketing') as HTMLInputElement)?.checked || false;
      const functional = (document.getElementById('cookie-functional') as HTMLInputElement)?.checked || false;

      saveConsentPreferences({
        analytics,
        marketing,
        functional
      });

      this.hideBanner();
      this.closeModal();
    }

    showBanner() {
      if (this.banner) {
        this.banner.classList.remove('translate-y-full');
        this.banner.setAttribute('aria-hidden', 'false');

        // Focus first button for accessibility
        setTimeout(() => {
          const firstButton = this.banner?.querySelector('button') as HTMLElement;
          firstButton?.focus();
        }, 300); // Wait for slide animation
      }
    }

    hideBanner() {
      if (this.banner) {
        this.banner.classList.add('translate-y-full');
        this.banner.setAttribute('aria-hidden', 'true');
      }
    }

    openModal() {
      if (this.modal) {
        // Store current focus for restoration
        this.previousFocus = document.activeElement as HTMLElement;

        // Load current or default preferences
        const preferences = getConsentPreferences() || getDefaultPreferences();

        (document.getElementById('cookie-analytics') as HTMLInputElement).checked = preferences.analytics;
        (document.getElementById('cookie-marketing') as HTMLInputElement).checked = preferences.marketing;
        (document.getElementById('cookie-functional') as HTMLInputElement).checked = preferences.functional;

        this.modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        // Focus close button for keyboard accessibility
        setTimeout(() => {
          const closeButton = document.getElementById('cookie-modal-close') as HTMLElement;
          closeButton?.focus();
        }, 50);
      }
    }

    closeModal() {
      if (this.modal) {
        this.modal.classList.add('hidden');
        document.body.style.overflow = '';

        // Restore focus to previous element
        if (this.previousFocus) {
          this.previousFocus.focus();
          this.previousFocus = null;
        }
      }
    }
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      new CookieConsentUI();
    });
  } else {
    new CookieConsentUI();
  }

  // Expose for manual control (e.g., footer link to reopen settings)
  (window as any).openCookieSettings = () => {
    const modal = document.getElementById('cookie-settings-modal');
    if (modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';

      // Focus close button
      setTimeout(() => {
        const closeButton = document.getElementById('cookie-modal-close') as HTMLElement;
        closeButton?.focus();
      }, 50);
    }
  };
</script>

<style>
  /* Smooth transitions */
  #cookie-banner {
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
  }

  /* Modal animations */
  #cookie-settings-modal:not(.hidden) .bg-white {
    animation: modalSlideUp 0.3s ease-out;
  }

  @keyframes modalSlideUp {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* Focus states for accessibility */
  button:focus-visible,
  input:focus-visible,
  a:focus-visible {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    #cookie-banner .container {
      padding-left: 1rem;
      padding-right: 1rem;
    }
  }

  /* Respect user's motion preferences */
  @media (prefers-reduced-motion: reduce) {
    #cookie-banner,
    #cookie-settings-modal * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }

    #cookie-settings-modal:not(.hidden) .bg-white {
      animation: none;
    }
  }
</style>
