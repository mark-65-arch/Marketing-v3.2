---
// 🧭 Global Navigation Component
// Purpose: Unified navigation across all pages with consistent layout and behavior
// Features: Sticky positioning, mobile menu, services dropdown, analytics tracking, accessibility

import LanguageSwitcher from './LanguageSwitcher.astro';
import ChevronDownIcon from './icons/ChevronDownIcon.astro';
import BarsIcon from './icons/BarsIcon.astro';
import HomeIcon from './icons/HomeIcon.astro';
import ListIcon from './icons/ListIcon.astro';
import DollarIcon from './icons/DollarIcon.astro';
import InfoCircleIcon from './icons/InfoCircleIcon.astro';
import EnvelopeIcon from './icons/EnvelopeIcon.astro';
import ChartLineIcon from './icons/ChartLineIcon.astro';
import GlobeIcon from './icons/GlobeIcon.astro';
import RocketIcon from './icons/RocketIcon.astro';
import ChartBarIcon from './icons/ChartBarIcon.astro';

interface Props {
  currentPath?: string;
  primaryCtaLabel?: string;
  primaryCtaHref?: string;
  showContactCTA?: boolean;
  stickyMobileCta?: boolean;
  currentLang?: string;
}

const {
  currentPath = '',
  primaryCtaLabel,
  primaryCtaHref = `${import.meta.env.BASE_URL}contact#contact-options`,
  showContactCTA = true,
  stickyMobileCta = true,
  currentLang = 'en'
} = Astro.props;

// Determine if Spanish
const isSpanish = currentLang === 'es';
const langPrefix = isSpanish ? 'es/' : '';

// Set default CTA label based on language
const ctaLabel = primaryCtaLabel || (isSpanish ? 'Contacto' : 'Call Now');

// 🧭 Navigation items configuration
const navItems = [
  { href: `${import.meta.env.BASE_URL}${langPrefix}`, label: isSpanish ? 'Inicio' : 'Home', active: currentPath === '/' || currentPath === '' },
  {
    href: '#services',
    label: isSpanish ? 'Servicios' : 'Services',
    active: currentPath.includes('business-profile-optimization') ||
            currentPath.includes('website-design') ||
            currentPath.includes('pro-website-growth') ||
            currentPath.includes('seo-growth'),
    dropdown: [
      { href: `${import.meta.env.BASE_URL}${langPrefix}business-profile-optimization`, label: isSpanish ? 'Ser Encontrado en Google (Plan Inicial)' : 'Get Found on Google (Starter Plan)' },
      { href: `${import.meta.env.BASE_URL}${langPrefix}website-design-that-converts`, label: isSpanish ? 'Construye la Base de tu Sitio Web (Plan de Crecimiento)' : 'Build Your Website Foundation (Growth Plan)' },
      { href: `${import.meta.env.BASE_URL}${langPrefix}pro-website-growth-plan`, label: isSpanish ? 'Expande tu Presencia en Línea (Plan Pro)' : 'Expand Your Online Presence (Pro Plan)' },
      { href: `${import.meta.env.BASE_URL}${langPrefix}${isSpanish ? 'services/' : ''}seo-growth-strategy`, label: isSpanish ? 'SEO y Optimización Continua (Plan de Soporte)' : 'Ongoing SEO & Optimization (Support Plan)' }
    ]
  },
  { href: `${import.meta.env.BASE_URL}${langPrefix}pricing`, label: isSpanish ? 'Precios' : 'Pricing', active: currentPath.includes('pricing') },
  { href: `${import.meta.env.BASE_URL}${langPrefix}about`, label: isSpanish ? 'Acerca de' : 'About', active: currentPath.includes('about') },
  { href: `${import.meta.env.BASE_URL}${langPrefix}contact`, label: isSpanish ? 'Contacto' : 'Contact', active: currentPath.includes('contact') }
];

// 🌐 Language Switcher URL Generation (same logic as LanguageSwitcher.astro)
const baseUrl = import.meta.env.BASE_URL || '/';
let cleanPath = currentPath;

// Remove BASE_URL prefix if it exists
if (cleanPath.startsWith(baseUrl) && baseUrl !== '/') {
  cleanPath = cleanPath.slice(baseUrl.length);
}

// Remove leading slash if present
if (cleanPath.startsWith('/')) {
  cleanPath = cleanPath.slice(1);
}

// Remove /es/ prefix if present
if (cleanPath.startsWith('es/')) {
  cleanPath = cleanPath.slice(3);
}

// Remove trailing slash
if (cleanPath.endsWith('/') && cleanPath.length > 1) {
  cleanPath = cleanPath.slice(0, -1);
}

// Handle special path mappings for pages with different structures
let englishUrl = '';
let spanishUrl = '';

if (cleanPath === 'seo-growth-strategy') {
  // English SEO page -> Spanish version is in services/
  englishUrl = `${baseUrl}seo-growth-strategy`;
  spanishUrl = `${baseUrl}es/services/seo-growth-strategy`;
} else if (cleanPath === 'services/seo-growth-strategy') {
  // Spanish SEO page -> English version is at root
  englishUrl = `${baseUrl}seo-growth-strategy`;
  spanishUrl = `${baseUrl}es/services/seo-growth-strategy`;
} else {
  // Standard mapping for all other pages
  englishUrl = `${baseUrl}${cleanPath}`;
  spanishUrl = `${baseUrl}es/${cleanPath}`;
}
---

<!-- ♿ Skip to Content Link (Accessibility) -->
<a
  href="#main-content"
  class="sr-only focus:not-sr-only focus:fixed focus:top-4 focus:left-4 bg-blue-600 text-white px-6 py-3 rounded-md z-[60] font-semibold shadow-lg transition-all"
  data-nav="skip-link"
>
  {isSpanish ? 'Saltar al contenido principal' : 'Skip to main content'}
</a>

<!-- 🧭 Global Navigation Header -->
<header class="sticky top-0 z-50 backdrop-blur-lg bg-white/90 border-b border-white/20 shadow-sm" role="banner" data-nav="global">
  <div class="container mx-auto px-3 sm:px-4 py-4">
    <!-- 📱 Mobile Layout: Logo (left) - Hamburger + CTA (right) -->
    <!-- 🖥️ Desktop Layout: Logo (left) - Nav (center) - Language + CTA (right) -->
    <div class="flex justify-between items-center md:gap-8">

      <!-- 🏠 Brand Logo (Left on Mobile and Desktop) -->
      <!-- Original icon (if you want to revert):
      <div class="w-10 h-10 bg-gradient-to-br from-blue-900 to-blue-600 rounded-full flex items-center justify-center mr-3 shadow-md">
        <RobotIcon class="text-white text-lg" />
      </div>
      -->
      <a
        href={import.meta.env.BASE_URL}
        class="flex items-center hover:opacity-80 transition-opacity md:order-1 order-1"
        aria-label="Marketing AI Houston - Home"
      >
        <img
          src={`${import.meta.env.BASE_URL}leaning-leaf.png`}
          alt="Marketing AI Houston - AI-powered digital marketing leaf logo with circuit pattern"
          width="44"
          height="44"
          fetchpriority="high"
          decoding="async"
          class="h-11 w-auto mr-1.5"
        />
        <span class="font-bold text-base font-['Poppins'] bg-gradient-to-r from-teal-600 to-teal-500 bg-clip-text text-transparent">
          <span class="hidden lg:inline">Marketing AI Houston</span>
          <span class="lg:hidden flex flex-col leading-tight">
            <span>Marketing AI</span>
            <span>Houston</span>
          </span>
        </span>
      </a>

      <!-- 🖥️ Desktop Navigation (Hidden on Mobile) -->
      <nav class="hidden md:flex md:space-x-4 lg:space-x-6 xl:space-x-8 md:order-2 flex-1 justify-center" role="navigation" aria-label="Main navigation">
        {navItems.map(item => (
          item.dropdown ? (
            <!-- 📋 Services Dropdown -->
            <div class="nav-dropdown">
              <button
                class={`py-3 px-4 font-medium transition-colors duration-200 hover:text-blue-600 focus:text-blue-600 focus:outline-none flex items-center cursor-pointer ${
                  item.active ? 'text-blue-600' : 'text-gray-700'
                }`}
                aria-expanded="false"
                aria-haspopup="true"
                type="button"
              >
                {item.label}
                <ChevronDownIcon class="dropdown-chevron ml-1 text-xs" />
              </button>

              <!-- 📂 Dropdown Menu -->
              <div class="dropdown-menu">
                <div class="py-2">
                  {item.dropdown.map(dropdownItem => (
                    <a
                      href={dropdownItem.href}
                      class="block px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors duration-200 border-b border-gray-50 last:border-b-0"
                    >
                      {dropdownItem.label}
                    </a>
                  ))}
                </div>
              </div>
            </div>
          ) : (
            <!-- 🔗 Regular Navigation Link -->
            <a
              href={item.href}
              class={`py-3 px-4 font-medium transition-colors duration-200 hover:text-blue-600 focus:text-blue-600 ${
                item.active ? 'text-blue-600' : 'text-gray-700'
              }`}
              {...(item.active && { 'aria-current': 'page' })}
            >
              {item.label}
            </a>
          )
        ))}
      </nav>

      <!-- 🎯 Hamburger Menu + CTA, Language Switcher (Right on Mobile and Desktop) -->
      <div class="flex items-center gap-2 md:gap-3 md:order-3 order-3">
        <!-- 🌐 Language Switcher (Desktop only) -->
        <div class="hidden md:block">
          <LanguageSwitcher currentPath={currentPath} currentLang={currentLang} />
        </div>

        <!-- 📱 Mobile Menu Toggle (Mobile Only) -->
        <button
          id="global-nav-mobile-menu-button"
          class="md:hidden p-3 rounded-lg text-blue-900 hover:bg-blue-50 focus:bg-blue-50 transition-colors duration-200"
          aria-expanded="false"
          aria-controls="global-nav-mobile-menu"
          aria-label="Toggle main menu"
        >
          <BarsIcon class="w-6 h-6" />
        </button>

        {showContactCTA && (
          <!-- 📞 Primary CTA Button -->
          <a
            href={primaryCtaHref}
            class="inline-flex bg-gradient-to-r from-blue-600 to-teal-600 hover:from-blue-700 hover:to-teal-700 text-white font-semibold py-3 px-3 md:px-4 lg:px-6 rounded-full transition-all duration-300 transform hover:scale-105 shadow-md focus:ring-4 focus:ring-blue-200 text-sm whitespace-nowrap"
            aria-label={ctaLabel}
          >
            {ctaLabel}
          </a>
        )}
      </div>
    </div>

    <!-- 📱 Mobile Navigation Menu -->
    <nav
      id="global-nav-mobile-menu"
      class="global-nav-mobile-menu mt-4 pb-4 hidden"
      role="navigation"
      aria-label="Mobile navigation"
      aria-hidden="true"
    >
      <div class="flex flex-col space-y-2 pt-2 px-2">
        {navItems.map((item, index) => {
          // Map items to their icons with blue-to-teal color distribution (Option D)
          const iconMap: { [key: number]: any } = {
            0: HomeIcon,      // Home
            1: ListIcon,      // Services
            2: DollarIcon,    // Pricing
            3: InfoCircleIcon, // About
            4: EnvelopeIcon   // Contact
          };
          // Color mapping for icons - all teal for unified brand look
          const iconColorMap: { [key: number]: string } = {
            0: 'text-teal-700',   // Home - teal
            1: 'text-teal-700',   // Services - teal
            2: 'text-teal-700',   // Pricing - teal
            3: 'text-teal-700',   // About - teal
            4: 'text-teal-700'    // Contact - teal
          };
          const IconComponent = iconMap[index];
          const iconColor = iconColorMap[index];

          return item.dropdown ? (
            <!-- 📋 Mobile Services Section (Collapsible) with Enhanced Styling -->
            <div class="mobile-dropdown">
              <button
                class="mobile-dropdown-toggle w-full py-3 px-4 font-medium text-gray-900 rounded-lg flex items-center justify-between hover:bg-blue-50/80 focus:bg-blue-50/80 active:bg-blue-100/60 transition-all duration-200 group"
                aria-expanded="false"
                aria-haspopup="true"
                type="button"
              >
                <span class="flex items-center gap-3">
                  {IconComponent && <IconComponent class={`w-5 h-5 text-teal-700 group-hover:text-teal-800 transition-colors duration-300`} />}
                  {item.label}
                </span>
                <svg class="mobile-dropdown-chevron w-5 h-5 text-teal-700 group-hover:text-teal-800 transition-transform duration-300" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </button>
              <div class="mobile-dropdown-menu pl-2 space-y-2 rounded-lg bg-blue-50/30 pt-2 pb-2 pr-2">
                {item.dropdown.map((dropdownItem, dropdownIndex) => {
                  // Icons for service items with gradient matching CTA button
                  const serviceIcons = [ChartLineIcon, GlobeIcon, RocketIcon, ChartBarIcon];
                  const ServiceIcon = serviceIcons[dropdownIndex] || ChartLineIcon;
                  return (
                    <a
                      href={dropdownItem.href}
                      class="flex items-center gap-3 py-2 px-3 font-medium text-gray-700 hover:text-teal-700 hover:bg-white/70 focus:text-teal-700 focus:bg-white/70 rounded-lg transition-all duration-200"
                      tabindex="-1"
                    >
                      <ServiceIcon class="w-4 h-4 text-teal-700 flex-shrink-0" />
                      <span>{dropdownItem.label}</span>
                    </a>
                  );
                })}
              </div>
            </div>
          ) : (
            <!-- 🔗 Regular Mobile Link with Icon -->
            <a
              href={item.href}
              class={`flex items-center gap-3 py-3 px-4 font-medium rounded-lg transition-all duration-200 ${
                item.active
                  ? 'text-gray-900 bg-blue-50/80 font-semibold'
                  : 'text-gray-700 hover:bg-blue-50/80 active:bg-blue-100/60'
              }`}
              {...(item.active && { 'aria-current': 'page' })}
              tabindex="-1"
            >
              {IconComponent && <IconComponent class={`w-5 h-5 flex-shrink-0 ${iconColor}`} />}
              {item.label}
            </a>
          );
        })}

        <!-- 🌐 Mobile Language Switcher -->
        <div class="border-t border-blue-100/50 pt-4 mt-4">
          <div class="mb-3 font-medium text-gray-900 text-sm px-2">{isSpanish ? 'Idioma' : 'Language'}</div>
          <div class="flex gap-2 px-2">
            <a
              href={englishUrl}
              lang="en"
              hreflang="en"
              class={`flex-1 py-2.5 px-3 rounded-lg text-center text-sm font-medium transition-all duration-200 ${
                !isSpanish
                  ? 'bg-gradient-to-r from-blue-600 to-teal-600 text-white shadow-md'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200 active:bg-gray-300'
              }`}
              tabindex="-1"
            >
              English
            </a>
            <a
              href={spanishUrl}
              lang="es"
              hreflang="es"
              class={`flex-1 py-2.5 px-3 rounded-lg text-center text-sm font-medium transition-all duration-200 ${
                isSpanish
                  ? 'bg-gradient-to-r from-blue-600 to-teal-600 text-white shadow-md'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200 active:bg-gray-300'
              }`}
              tabindex="-1"
            >
              Español
            </a>
          </div>
        </div>
      </div>
    </nav>
  </div>
</header>

{stickyMobileCta && (
  <!-- 📱 Sticky Mobile "Get Started" Button -->
  <div
    id="global-nav-sticky-mobile-cta"
    class="md:hidden fixed bottom-0 left-0 right-0 z-40 bg-white border-t border-gray-200 shadow-lg px-4 py-3 transform translate-y-full transition-transform duration-300"
  >
    <a
      href={primaryCtaHref}
      class="block w-full bg-gradient-to-r from-blue-600 to-teal-600 hover:from-blue-700 hover:to-teal-700 text-white font-semibold py-3 px-6 rounded-full text-center shadow-md transition-all duration-300"
      aria-label={isSpanish ? 'Comenzar' : 'Get Started'}
    >
      {isSpanish ? 'Comenzar' : 'Get Started'}
    </a>
  </div>
)}

<style>
  /* ♿ Skip to content link - Accessibility */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .focus\\:not-sr-only:focus {
    position: fixed;
    width: auto;
    height: auto;
    padding: 0.75rem 1.5rem;
    margin: 0;
    overflow: visible;
    clip: auto;
    white-space: normal;
  }

  /* 📱 Mobile menu animation with enhanced styling */
  .global-nav-mobile-menu {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, opacity 0.3s ease-out, background-color 0.3s ease-out;
    opacity: 0;
    background: transparent;
    border-top: 1px solid transparent;
  }

  .global-nav-mobile-menu.active {
    max-height: 700px;
    opacity: 1;
    display: block;
    background: linear-gradient(to bottom, rgba(255, 255, 255, 0.95), rgba(240, 249, 255, 0.5));
    border-top: 1px solid rgba(191, 219, 254, 0.3);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
  }

  /* 🎯 Smooth header backdrop blur */
  header {
    -webkit-backdrop-filter: blur(12px);
    backdrop-filter: blur(12px);
  }

  /* 📋 Desktop Dropdown Menu */
  .nav-dropdown {
    position: relative;
  }

  .nav-dropdown .dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 0;
    padding-top: 0.5rem;
    width: 16rem;
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    border: 1px solid rgba(0, 0, 0, 0.05);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all 0.2s ease-out;
    z-index: 50;
    pointer-events: none;
  }

  /* Create invisible bridge to prevent hover gaps */
  .nav-dropdown::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    height: 0.5rem;
    background: transparent;
    z-index: 49;
  }

  .nav-dropdown:hover .dropdown-menu,
  .nav-dropdown.active .dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
  }

  .nav-dropdown:hover .dropdown-chevron,
  .nav-dropdown.active .dropdown-chevron {
    transform: rotate(180deg);
  }

  .dropdown-chevron {
    transition: transform 0.2s ease-out;
  }

  /* 🎯 Ensure dropdown stays open when hovering over menu items */
  .nav-dropdown:hover,
  .nav-dropdown.active {
    z-index: 51;
  }

  /* 📱 Mobile Services Dropdown (Collapsible Accordion) with Enhanced Styling */
  .mobile-dropdown-toggle {
    /* Safari-specific fix: Ensure button is clickable */
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    cursor: pointer;
  }

  /* Ensure all children of the toggle button don't interfere with clicks */
  .mobile-dropdown-toggle * {
    pointer-events: none;
  }

  .mobile-dropdown-menu {
    display: none;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, margin-bottom 0.3s ease-out, opacity 0.3s ease-out;
    margin-bottom: 0;
    opacity: 0;
  }

  .mobile-dropdown-menu.active {
    display: block;
    max-height: 500px;
    margin-bottom: 0;
    opacity: 1;
  }

  /* Re-enable pointer events for dropdown menu items */
  .mobile-dropdown-menu a {
    pointer-events: auto;
  }

  .mobile-dropdown-chevron {
    transform: rotate(0deg);
    transition: transform 0.3s ease-out;
  }

  .mobile-dropdown.active .mobile-dropdown-chevron {
    transform: rotate(180deg);
  }

  /* Enhance mobile dropdown menu items on hover */
  .mobile-dropdown-menu a {
    border-left: 3px solid transparent;
    padding-left: calc(0.75rem - 3px);
    transition: all 0.2s ease-out;
  }

  .mobile-dropdown-menu a:hover,
  .mobile-dropdown-menu a:focus {
    border-left-color: rgb(59, 130, 246);
    padding-left: 0.75rem;
  }

</style>