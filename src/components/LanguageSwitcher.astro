---
// üåê Language Switcher Component
// Purpose: Toggle between English and Spanish versions of pages
// Features: Keyboard accessible, screen reader friendly, preserves current route

import GlobeIcon from './icons/GlobeIcon.astro';
import ChevronDownIcon from './icons/ChevronDownIcon.astro';
import CheckIcon from './icons/CheckIcon.astro';

interface Props {
  currentPath?: string;
  currentLang?: string;
}

const {
  currentPath = Astro.url.pathname,
  currentLang = 'en'
} = Astro.props;

// Remove BASE_URL and /es/ prefix to get the clean path
const baseUrl = import.meta.env.BASE_URL || '/';
let cleanPath = currentPath;

// Remove BASE_URL prefix if it exists
if (cleanPath.startsWith(baseUrl) && baseUrl !== '/') {
  cleanPath = cleanPath.slice(baseUrl.length);
}

// Remove leading slash if present
if (cleanPath.startsWith('/')) {
  cleanPath = cleanPath.slice(1);
}

// Remove /es/ prefix if present
if (cleanPath.startsWith('es/')) {
  cleanPath = cleanPath.slice(3);
}

// Remove trailing slash
if (cleanPath.endsWith('/') && cleanPath.length > 1) {
  cleanPath = cleanPath.slice(0, -1);
}

// Generate the alternate language URL
const isCurrentlySpanish = currentLang === 'es' || currentPath.includes('/es/');

// Handle special path mappings for pages with different structures
let alternateUrl = '';
let englishUrl = '';

if (cleanPath === 'seo-growth-strategy') {
  // English SEO page -> Spanish version is in services/
  englishUrl = `${baseUrl}seo-growth-strategy`;
  alternateUrl = `${baseUrl}es/services/seo-growth-strategy`;
} else if (cleanPath === 'services/seo-growth-strategy') {
  // Spanish SEO page -> English version is at root
  englishUrl = `${baseUrl}seo-growth-strategy`;
  alternateUrl = `${baseUrl}seo-growth-strategy`;
} else {
  // Standard mapping for all other pages
  englishUrl = `${baseUrl}${cleanPath}`;
  alternateUrl = isCurrentlySpanish
    ? `${baseUrl}${cleanPath}`  // Switch to English
    : `${baseUrl}es/${cleanPath}`; // Switch to Spanish
}

const alternateLang = isCurrentlySpanish ? 'en' : 'es';
const alternateLangLabel = isCurrentlySpanish ? 'English' : 'Espa√±ol';
const currentLangLabel = isCurrentlySpanish ? 'Espa√±ol' : 'English';
---

<div class="language-switcher" role="navigation" aria-label="Language switcher">
  <button
    type="button"
    class="lang-toggle-button group flex items-center px-3 sm:px-4 py-2 rounded-full bg-gradient-to-r from-blue-50 to-teal-50 hover:from-blue-100 hover:to-teal-100 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-200 shadow-sm"
    aria-label={`Switch language to ${alternateLangLabel}`}
    aria-expanded="false"
    data-alternate-url={alternateUrl}
    data-alternate-lang={alternateLang}
  >
    <GlobeIcon class="hidden sm:block w-4 h-4 bg-gradient-to-r from-blue-600 to-teal-600 bg-clip-text text-transparent group-hover:from-blue-700 group-hover:to-teal-700" />
    <span class="font-semibold text-sm bg-gradient-to-r from-blue-600 to-teal-600 bg-clip-text text-transparent hidden sm:inline sm:ml-2">{currentLangLabel}</span>
    <span class="font-semibold text-sm bg-gradient-to-r from-blue-600 to-teal-600 bg-clip-text text-transparent sm:hidden">{currentLang.toUpperCase()}</span>
    <ChevronDownIcon class="w-3 h-3 text-blue-600 group-hover:text-teal-600 transition-all duration-300 lang-chevron ml-1.5 sm:ml-2" />
  </button>

  <!-- Dropdown menu -->
  <div class="lang-dropdown absolute right-0 mt-2 w-44 bg-white/95 backdrop-blur-sm rounded-xl shadow-xl border border-white/50 opacity-0 invisible transform -translate-y-2 transition-all duration-300 z-50">
    <div class="py-2">
      <a
        href={englishUrl}
        class={`flex items-center gap-2 px-4 py-3 text-sm transition-all duration-200 rounded-lg mx-2 ${!isCurrentlySpanish ? 'bg-gradient-to-r from-blue-600 to-teal-600 text-white font-semibold shadow-md' : 'text-gray-700 hover:bg-gradient-to-r hover:from-blue-50 hover:to-teal-50'}`}
        lang="en"
        hreflang="en"
      >
        <CheckIcon class={`w-3 h-3 ${!isCurrentlySpanish ? 'opacity-100' : 'opacity-0'}`} />
        <span class="flex-1">English</span>
      </a>
      <a
        href={alternateUrl}
        class={`flex items-center gap-2 px-4 py-3 text-sm transition-all duration-200 rounded-lg mx-2 ${isCurrentlySpanish ? 'bg-gradient-to-r from-blue-600 to-teal-600 text-white font-semibold shadow-md' : 'text-gray-700 hover:bg-gradient-to-r hover:from-blue-50 hover:to-teal-50'}`}
        lang="es"
        hreflang="es"
      >
        <CheckIcon class={`w-3 h-3 ${isCurrentlySpanish ? 'opacity-100' : 'opacity-0'}`} />
        <span class="flex-1">Espa√±ol</span>
      </a>
    </div>
  </div>
</div>

<style>
  .language-switcher {
    position: relative;
  }

  .lang-toggle-button:hover + .lang-dropdown,
  .lang-dropdown:hover {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  /* Keyboard navigation support */
  .lang-toggle-button:focus + .lang-dropdown,
  .lang-toggle-button[aria-expanded="true"] + .lang-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  /* Rotate chevron when dropdown is open */
  .lang-toggle-button:hover .lang-chevron,
  .lang-toggle-button[aria-expanded="true"] .lang-chevron {
    transform: rotate(180deg);
  }
</style>

<script>
  import '../scripts/language-switcher.js';
</script>
