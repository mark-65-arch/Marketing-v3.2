---
// 🎯 Base Layout Component
// Purpose: Consistent HTML structure, SEO optimization, and performance best practices
// Used by: All pages across the site
import '../styles/global.css';
import CookieBanner from '../components/CookieBanner.astro';

interface Props {
  title?: string;
  description?: string;
  canonicalURL?: string;
  ogImage?: string;
  noindex?: boolean;
  structuredData?: object;
  lang?: string;
  alternateLanguages?: { lang: string; url: string }[];
  pageType?: string;
  currentPath?: string;
  preloadImages?: string[];
}

const {
  title = "Marketing AI Houston - AI-Powered Web Design & SEO for Small Businesses",
  description = "Professional web design and SEO services powered by AI technology for Houston small businesses. Get found online with modern, conversion-focused websites.",
  canonicalURL,
  ogImage = `${import.meta.env.SITE}${import.meta.env.BASE_URL}og-image.png`,
  noindex = false,
  structuredData,
  lang = "en",
  alternateLanguages = [],
  pageType = 'home',
  currentPath = Astro.url.pathname,
  preloadImages = []
} = Astro.props;

// 🔍 SEO: Generate canonical URL if not provided
const currentCanonical = canonicalURL || new URL(Astro.url.pathname, Astro.site).toString();

// 🎯 Performance: Preload critical resources
// IMPORTANT: LCP images MUST be preloaded FIRST with fetchpriority="high"
// Then fonts are preloaded to break critical request chain
const imagePreloads = preloadImages.map(imagePath => {
  // Detect image type from file extension
  const imageType = imagePath.endsWith('.avif') ? 'image/avif' :
                    imagePath.endsWith('.webp') ? 'image/webp' :
                    imagePath.endsWith('.jpg') || imagePath.endsWith('.jpeg') ? 'image/jpeg' :
                    'image/png';

  return {
    href: imagePath,
    rel: 'preload' as const,
    as: 'image' as const,
    type: imageType,
    fetchpriority: 'high' as const
  };
});

// Only preload fonts used above the fold (Poppins 900 for headings, Inter 400 for body)
const fontPreloads = [
  { href: `${import.meta.env.BASE_URL}fonts/poppins-900.woff2`, rel: 'preload' as const, as: 'font' as const, type: 'font/woff2', crossorigin: 'anonymous' as const },
  { href: `${import.meta.env.BASE_URL}fonts/inter-400.woff2`, rel: 'preload' as const, as: 'font' as const, type: 'font/woff2', crossorigin: 'anonymous' as const },
];

// Combine with images FIRST (highest priority for LCP)
const preloadResources = [...imagePreloads, ...fontPreloads];
---

<!DOCTYPE html>
<html lang={lang} dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ⚡ Performance: DNS prefetch for third-party resources -->
  <link rel="dns-prefetch" href="https://www.googletagmanager.com" />

  <!-- ⚡ CRITICAL: Preload LCP image and fonts FIRST for fastest render -->
  {preloadResources.map(resource => (
    <link {...resource} />
  ))}

  <meta name="generator" content={Astro.generator} />

  <!-- 🔍 SEO: Basic meta tags -->
  <title>{title}</title>
  <meta name="description" content={description} />
  <link rel="canonical" href={currentCanonical} />

  <!-- 🌐 SEO: Hreflang for multilingual support -->
  {alternateLanguages.map(({ lang: altLang, url }) => (
    <link rel="alternate" hreflang={altLang} href={url} />
  ))}

  <!-- 🎨 Favicons -->
  <link rel="icon" type="image/png" href={`${import.meta.env.BASE_URL}favicon-96x96.png`} sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href={`${import.meta.env.BASE_URL}favicon.svg`} />
  <link rel="shortcut icon" href={`${import.meta.env.BASE_URL}favicon.ico`} />
  <link rel="apple-touch-icon" sizes="180x180" href={`${import.meta.env.BASE_URL}apple-touch-icon.png`} />
  <meta name="apple-mobile-web-app-title" content="Marketing AI Houston" />
  <link rel="manifest" href={`${import.meta.env.BASE_URL}site.webmanifest`} />

  <!-- 🚫 SEO: Robots directive -->
  {noindex && <meta name="robots" content="noindex, nofollow" />}

  <!-- 📱 Open Graph / Social Media -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content={title} />
  <meta property="og:description" content={description} />
  <meta property="og:url" content={currentCanonical} />
  <meta property="og:image" content={ogImage} />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:alt" content={`${title} - Marketing AI Houston`} />
  <meta property="og:site_name" content="Marketing AI Houston" />

  <!-- 🐦 Twitter Cards -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content={title} />
  <meta name="twitter:description" content={description} />
  <meta name="twitter:image" content={ogImage} />
  <meta name="twitter:image:alt" content={`${title} - Marketing AI Houston`} />

  <!-- 🏢 Organization Schema - Site-wide structured data -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Marketing AI Houston",
    "description": "AI-powered web design & SEO for Houston small businesses",
    "url": `${import.meta.env.SITE}${import.meta.env.BASE_URL}`,
    "logo": `${import.meta.env.SITE}${import.meta.env.BASE_URL}logo.png`,
    "email": "team@marketingaihouston.com",
    "telephone": "+1-281-544-0572",
    "contactPoint": {
      "@type": "ContactPoint",
      "email": "team@marketingaihouston.com",
      "contactType": "Customer Service",
      "areaServed": "US",
      "availableLanguage": ["English", "Spanish"]
    },
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "Houston",
      "addressRegion": "TX",
      "addressCountry": "US"
    },
    "sameAs": [
      "https://www.linkedin.com/company/marketing-ai-houston",
      "https://www.facebook.com/marketingaihouston",
      "https://twitter.com/marketingaihou"
    ]
  })} />

  <!-- 📊 Additional structured data from page -->
  {structuredData && (
    <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  )}

  <!-- Google Tag Manager with Consent Mode v2 (externalized for CSP compliance) -->
  <!-- Moved AFTER critical resources to prevent discovery delay -->
  <script defer src={`${import.meta.env.BASE_URL}js/gtm-init.js`}></script>
  <!-- End Google Tag Manager -->

  <!-- 🎨 Critical CSS: Inlined font-face declarations for faster FCP -->
  <style set:html={`
    /* Self-hosted fonts - Inlined to eliminate render-blocking request */

    /* Critical fonts (preloaded) - use swap for immediate render */
    @font-face {
      font-family: 'Poppins';
      font-style: normal;
      font-weight: 900;
      font-display: swap;
      src: url('${import.meta.env.BASE_URL}fonts/poppins-900.woff2') format('woff2');
    }

    @font-face {
      font-family: 'Inter';
      font-style: normal;
      font-weight: 400;
      font-display: swap;
      src: url('${import.meta.env.BASE_URL}fonts/inter-400.woff2') format('woff2');
    }

    /* Non-critical fonts (not preloaded) - use optional to prevent render blocking */
    @font-face {
      font-family: 'Inter';
      font-style: normal;
      font-weight: 600;
      font-display: optional;
      src: url('${import.meta.env.BASE_URL}fonts/inter-600.woff2') format('woff2');
    }

    @font-face {
      font-family: 'Poppins';
      font-style: normal;
      font-weight: 700;
      font-display: optional;
      src: url('${import.meta.env.BASE_URL}fonts/poppins-700.woff2') format('woff2');
    }
  `}></style>

  <!-- 🛡️ Security: CSP moved to HTTP headers in public/_headers for better security -->
  <!-- External scripts are now used instead of inline scripts for CSP compliance -->

  <style>
    /* 🎨 Critical CSS: Design system variables */
    :root {
      --color-ocean-deep: #0A2540;
      --color-ocean-deeper: #020617;
      --color-ocean-blue: #3B82F6;
      --color-ocean-light: #60A5FA;
      --color-ocean-teal: #198072;
      --color-ocean-teal-dark: #14B8A6;
      --color-ocean-sky: #BFDBFE;

      /* 🎯 Performance: Consistent spacing scale */
      --space-xs: 0.25rem;
      --space-sm: 0.5rem;
      --space-md: 1rem;
      --space-lg: 1.5rem;
      --space-xl: 2rem;
      --space-2xl: 3rem;
      --space-3xl: 4rem;

      /* 📱 Responsive typography scale */
      --text-xs: 0.75rem;
      --text-sm: 0.875rem;
      --text-base: 1rem;
      --text-lg: 1.125rem;
      --text-xl: 1.25rem;
      --text-2xl: 1.5rem;
      --text-3xl: 1.875rem;
      --text-4xl: 2.25rem;
      --text-5xl: 3rem;
    }

    /* 🎨 Typography system */
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Poppins', sans-serif;
      font-weight: 900;
      line-height: 1.2;
    }

    p, a, span, li, label, input, textarea {
      font-family: 'Inter', sans-serif;
    }

    /* 🎯 Performance: Reduce layout shift */
    img, video, iframe {
      height: auto;
      max-width: 100%;
    }

    /* ♿ Accessibility: Focus indicators */
    *:focus {
      outline: 2px solid var(--color-ocean-blue);
      outline-offset: 2px;
    }

    /* 🎨 Custom organic shapes */
    .organic-blob {
      border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
    }

    .organic-droplet {
      border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
    }

    .organic-leaf {
      border-radius: 20% 80% 20% 80% / 80% 20% 80% 20%;
    }

    /* 🎨 Gradient utilities */
    .gradient-ocean {
      background: linear-gradient(135deg, var(--color-ocean-deep), var(--color-ocean-blue));
    }

    .gradient-ocean-teal {
      background: linear-gradient(135deg, var(--color-ocean-blue), var(--color-ocean-teal));
    }

    /* ⚡ Performance: GPU-accelerated animations */
    @keyframes float {
      0%, 100% { transform: translate3d(0, 0, 0); }
      50% { transform: translate3d(0, -20px, 0); }
    }

    @keyframes blob {
      0%, 100% { transform: translate3d(0, 0, 0) scale(1); }
      33% { transform: translate3d(30px, -50px, 0) scale(1.1); }
      66% { transform: translate3d(-20px, 20px, 0) scale(0.9); }
    }

    .animate-float {
      animation: float 6s ease-in-out infinite;
    }

    .animate-blob {
      animation: blob 7s infinite;
    }

    /* Disable animations on mobile for better performance */
    @media (max-width: 768px) {
      .animate-float,
      .animate-blob {
        animation: none;
      }
    }

    /* Respect user motion preferences */
    @media (prefers-reduced-motion: reduce) {
      .animate-float,
      .animate-blob {
        animation: none;
      }
    }

    /* 🎯 Performance: Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }

    /* 📱 Mobile-first responsive utilities */
    @media (max-width: 640px) {
      :root {
        --text-5xl: 2.25rem;
        --text-4xl: 1.875rem;
      }
    }
  </style>

  <!-- 🎯 Additional page-specific head content -->
  <slot name="head" />
</head>

<body class="font-inter text-gray-800 bg-gradient-to-br from-blue-100 to-white antialiased" data-page-type={pageType} data-current-path={currentPath}>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KQS29VV6"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <!-- 🎯 Layout: Main content area -->
  <main id="main-content">
    <slot />
  </main>

  <!-- 🍪 Cookie Consent Banner -->
  <CookieBanner currentLang={lang} />

  <!-- ⚡ Performance & Security: External utilities script (CSP compliant, deferred) -->
  <script defer src={`${import.meta.env.BASE_URL}js/utilities.js`}></script>

  <!-- 🧭 Navigation: Global nav functionality (CSP compliant, deferred) -->
  <script defer src={`${import.meta.env.BASE_URL}js/global-nav.js`}></script>

  <!-- 🌐 Language Switcher: Toggle language functionality (CSP compliant, deferred) -->
  <script defer src={`${import.meta.env.BASE_URL}js/language-switcher.js`}></script>

  <!-- 📄 Main Layout: Page-specific interactions (CSP compliant, deferred) -->
  <script defer src={`${import.meta.env.BASE_URL}js/main-layout.js`}></script>

  <!-- 🍪 Cookie Banner: Cookie consent management (CSP compliant, deferred) -->
  <script defer src={`${import.meta.env.BASE_URL}js/cookie-banner.js`}></script>

  <!-- 🔙 Footer: Back to top and newsletter functionality (CSP compliant, deferred) -->
  <script defer src={`${import.meta.env.BASE_URL}js/footer.js`}></script>
</body>
</html>