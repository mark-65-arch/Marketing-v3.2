---
import MainLayout from '../layouts/MainLayout.astro';

const pageTitle = 'Cookie Consent Test Page | Marketing AI Houston';
const pageDescription = 'Test page for cookie consent and analytics integration';
const canonicalURL = `${import.meta.env.SITE}${import.meta.env.BASE_URL}cookie-consent-test`;

const breadcrumbs = [
  { name: 'Home', url: `${import.meta.env.SITE}${import.meta.env.BASE_URL}` },
  { name: 'Cookie Consent Test', url: canonicalURL }
];
---

<MainLayout
  title={pageTitle}
  description={pageDescription}
  canonicalURL={canonicalURL}
  breadcrumbs={breadcrumbs}
  pageType="about"
>
  <div class="min-h-screen bg-gradient-to-b from-blue-50 to-white py-12 sm:py-16 lg:py-20">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">

      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-4xl font-bold text-slate-900 mb-4">
          üç™ Cookie Consent Test Page
        </h1>
        <p class="text-lg text-gray-600">
          Use this page to test cookie consent functionality and verify that analytics tracking respects user preferences.
        </p>
      </div>

      <!-- Consent Status Card -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <h2 class="text-2xl font-bold text-slate-900 mb-4">Current Consent Status</h2>

        <div id="consent-status" class="space-y-3">
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <span class="font-medium">Consent Given:</span>
            <span id="status-has-consent" class="px-3 py-1 rounded-full text-sm font-semibold"></span>
          </div>
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <span class="font-medium">Strictly Necessary:</span>
            <span id="status-necessary" class="px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800">‚úì Enabled</span>
          </div>
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <span class="font-medium">Analytics:</span>
            <span id="status-analytics" class="px-3 py-1 rounded-full text-sm font-semibold"></span>
          </div>
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <span class="font-medium">Marketing:</span>
            <span id="status-marketing" class="px-3 py-1 rounded-full text-sm font-semibold"></span>
          </div>
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <span class="font-medium">Functional:</span>
            <span id="status-functional" class="px-3 py-1 rounded-full text-sm font-semibold"></span>
          </div>
        </div>

        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <p class="text-sm text-blue-900">
            <strong>Note:</strong> If no consent has been given yet, analytics is enabled by default.
            You can see this by checking the network tab for GTM/GA requests.
          </p>
        </div>
      </div>

      <!-- Test Actions Card -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <h2 class="text-2xl font-bold text-slate-900 mb-4">Test Actions</h2>

        <div class="space-y-3">
          <button
            onclick="window.openCookieSettings()"
            class="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors"
          >
            Open Cookie Settings
          </button>

          <button
            id="clear-consent-btn"
            class="w-full px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors"
          >
            Clear All Consent (Reset)
          </button>

          <button
            id="track-event-btn"
            class="w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors"
          >
            Send Test Analytics Event
          </button>
        </div>
      </div>

      <!-- Network Monitor Card -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <h2 class="text-2xl font-bold text-slate-900 mb-4">Network Monitoring</h2>

        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg mb-4">
          <p class="text-sm text-yellow-900">
            <strong>How to verify:</strong> Open your browser's Developer Tools (F12) ‚Üí Network tab ‚Üí Filter by "google" or "gtm"
          </p>
        </div>

        <div class="space-y-2">
          <h3 class="font-semibold text-gray-700">What to look for:</h3>
          <ul class="list-disc list-inside text-gray-600 space-y-1 text-sm">
            <li><strong>Analytics Enabled:</strong> You should see requests to <code>googletagmanager.com</code> and <code>google-analytics.com</code></li>
            <li><strong>Analytics Disabled:</strong> No new GA/GTM requests should appear after disabling</li>
            <li><strong>After Opt-out:</strong> GA cookies (_ga, _gid) should be removed from Application ‚Üí Cookies</li>
          </ul>
        </div>
      </div>

      <!-- Event Log Card -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-slate-900 mb-4">Event Log</h2>

        <div id="event-log" class="bg-gray-900 text-green-400 font-mono text-sm p-4 rounded-lg h-64 overflow-y-auto">
          <div class="text-gray-500">Waiting for events...</div>
        </div>

        <button
          id="clear-log-btn"
          class="mt-3 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded transition-colors"
        >
          Clear Log
        </button>
      </div>

      <!-- Instructions -->
      <div class="mt-8 p-6 bg-gray-50 rounded-xl">
        <h3 class="text-lg font-bold text-slate-900 mb-3">Testing Instructions</h3>
        <ol class="list-decimal list-inside space-y-2 text-gray-700">
          <li>Open browser DevTools (F12) and go to Network tab</li>
          <li>Clear your site data (Application ‚Üí Storage ‚Üí Clear site data) to see the banner</li>
          <li>Reload the page - you should see analytics loading (GTM requests in Network tab)</li>
          <li>Click "Reject non-essential" and verify no new analytics requests</li>
          <li>Click "Clear All Consent" button to reset and test again</li>
          <li>Try the "Cookie settings" to enable/disable individual categories</li>
          <li>Send test events and verify they only go through when analytics is enabled</li>
        </ol>
      </div>

    </div>
  </div>

  <script>
    import {
      getConsentPreferences,
      hasGivenConsent,
      isAnalyticsEnabled,
      isFunctionalEnabled,
      isMarketingEnabled,
      removeConsentPreferences
    } from '../utils/consent';
    import { trackEvent } from '../utils/analytics';

    // Event log functionality
    const eventLog = document.getElementById('event-log');
    let logEntries: string[] = [];

    function addLog(message: string) {
      const timestamp = new Date().toLocaleTimeString();
      const entry = `[${timestamp}] ${message}`;
      logEntries.push(entry);

      if (eventLog) {
        eventLog.innerHTML = logEntries.map(e => `<div>${e}</div>`).join('');
        eventLog.scrollTop = eventLog.scrollHeight;
      }
    }

    // Update consent status display
    function updateConsentStatus() {
      const hasConsent = hasGivenConsent();
      const preferences = getConsentPreferences();

      // Has Consent
      const hasConsentEl = document.getElementById('status-has-consent');
      if (hasConsentEl) {
        if (hasConsent) {
          hasConsentEl.textContent = '‚úì Yes';
          hasConsentEl.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800';
        } else {
          hasConsentEl.textContent = '‚úó No (Using Defaults)';
          hasConsentEl.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-yellow-100 text-yellow-800';
        }
      }

      // Analytics
      const analyticsEnabled = isAnalyticsEnabled();
      const analyticsEl = document.getElementById('status-analytics');
      if (analyticsEl) {
        if (analyticsEnabled) {
          analyticsEl.textContent = '‚úì Enabled';
          analyticsEl.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800';
        } else {
          analyticsEl.textContent = '‚úó Disabled';
          analyticsEl.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800';
        }
      }

      // Marketing
      const marketingEnabled = isMarketingEnabled();
      const marketingEl = document.getElementById('status-marketing');
      if (marketingEl) {
        if (marketingEnabled) {
          marketingEl.textContent = '‚úì Enabled';
          marketingEl.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800';
        } else {
          marketingEl.textContent = '‚úó Disabled';
          marketingEl.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-gray-100 text-gray-800';
        }
      }

      // Functional
      const functionalEnabled = isFunctionalEnabled();
      const functionalEl = document.getElementById('status-functional');
      if (functionalEl) {
        if (functionalEnabled) {
          functionalEl.textContent = '‚úì Enabled';
          functionalEl.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800';
        } else {
          functionalEl.textContent = '‚úó Disabled';
          functionalEl.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-gray-100 text-gray-800';
        }
      }

      addLog(`Consent status updated: Analytics=${analyticsEnabled}, Marketing=${marketingEnabled}, Functional=${functionalEnabled}`);
    }

    // Clear consent
    document.getElementById('clear-consent-btn')?.addEventListener('click', () => {
      removeConsentPreferences();
      addLog('‚úÖ All consent preferences cleared');
      setTimeout(() => {
        location.reload();
      }, 500);
    });

    // Send test event
    document.getElementById('track-event-btn')?.addEventListener('click', () => {
      if (isAnalyticsEnabled()) {
        trackEvent('test_event', {
          category: 'Test',
          action: 'Button Click',
          label: 'Test Analytics Event'
        });
        addLog('üìä Test analytics event sent');
      } else {
        addLog('‚ùå Cannot send event: Analytics is disabled');
      }
    });

    // Clear log
    document.getElementById('clear-log-btn')?.addEventListener('click', () => {
      logEntries = [];
      if (eventLog) {
        eventLog.innerHTML = '<div class="text-gray-500">Log cleared...</div>';
      }
    });

    // Listen for consent changes
    window.addEventListener('consentChanged', (e: Event) => {
      const customEvent = e as CustomEvent;
      addLog(`üîÑ Consent changed: ${JSON.stringify(customEvent.detail)}`);
      updateConsentStatus();
    });

    // Initial load
    addLog('üöÄ Test page loaded');
    updateConsentStatus();
  </script>
</MainLayout>
